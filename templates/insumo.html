{% extends "base.html" %}

{% block content %}
<h2>Gestión de Insumos</h2>

<label for="actionSelect"><strong>Acción:</strong></label>
<select id="actionSelect" class="form-control" style="max-width:420px;margin-bottom:1rem;">
  <option value="add">Añadir Insumo</option>
  <option value="list">Ver Insumos</option>
  <option value="detail">Ver detalles de Insumo</option>
  <option value="update">Modificar Insumo</option>
  <option value="delete">Eliminar Insumo</option>
</select>


<!-- Formularios -->
<div id="form-add" class="insumo-form">
  <h4>Añadir Insumo</h4>
  <form id="addForm">
    {% csrf_token %}
    <div class="form-group">
      <label>Nombre</label>
      <input name="nombre_insumo" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Tipo</label>
      <input name="tipo_insumo" class="form-control" />
    </div>
    <div class="form-group">
      <label>Cantidad disponible</label>
      <input type="number" name="cantidad_disponible_insumo" class="form-control" min="0" />
    </div>
    <div class="form-group">
      <label>Marca</label>
      <input name="marca_insumo" class="form-control" />
    </div>
    <div class="form-group">
      <label>Color (hex)</label>
      <input name="color_insumo" type="color" class="form-control" value="#ffffff" />
    </div>
    <button type="submit" class="btn btn-primary">Crear</button>
  </form>
  <div id="addResult" style="margin-top:.5rem;"></div>
</div>

<div id="form-list" class="insumo-form" style="display:none;">
  <h4>Lista de Insumos</h4>
  <button id="refreshList" class="btn btn-secondary">Refrescar</button>
  <div id="listResult" style="margin-top:.75rem;"></div>
</div>

<div id="form-detail" class="insumo-form" style="display:none;">
  <h4>Detalles de Insumo</h4>
  <form id="detailForm">
    {% csrf_token %}
    <div class="form-group">
      <label>ID del Insumo</label>
      <input name="id" class="form-control" required />
    </div>
    <button type="submit" class="btn btn-primary">Ver</button>
  </form>
  <div id="detailResult" style="margin-top:.75rem;"></div>
</div>

<div id="form-update" class="insumo-form" style="display:none;">
  <h4>Modificar Insumo</h4>
  <form id="updateForm">
    {% csrf_token %}
    <div class="form-group"><label>ID (a modificar)</label><input name="id" class="form-control" required /></div>
    <div class="form-group"><label>Nombre</label><input name="nombre_insumo" class="form-control" /></div>
    <div class="form-group"><label>Tipo</label><input name="tipo_insumo" class="form-control" /></div>
    <div class="form-group"><label>Cantidad disponible</label><input type="number" name="cantidad_disponible_insumo" class="form-control" min="0" /></div>
    <div class="form-group"><label>Marca</label><input name="marca_insumo" class="form-control" /></div>
    <div class="form-group"><label>Color</label><input name="color_insumo" type="color" class="form-control" /></div>
    <button type="submit" class="btn btn-warning">Actualizar</button>
  </form>
  <div id="updateResult" style="margin-top:.75rem;"></div>
</div>

<div id="form-delete" class="insumo-form" style="display:none;">
  <h4>Eliminar Insumo</h4>
  <form id="deleteForm">
    {% csrf_token %}
    <div class="form-group"><label>ID (a eliminar)</label><input name="id" class="form-control" required /></div>
    <button type="submit" class="btn btn-danger">Eliminar</button>
  </form>
  <div id="deleteResult" style="margin-top:.75rem;"></div>
</div>




<script>
// Helpers
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');



//Cambios por opción
const accion = document.getElementById('actionSelect');
const forms = document.querySelectorAll('.insumo-form');
accion.addEventListener('change', function(){
  forms.forEach(f => f.style.display = 'none');
  const sel = this.value;
  document.getElementById('form-' + sel).style.display = '';
});




//Añadir Insumo
document.getElementById('addForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this).entries());
  const res = await fetch('/api/insumos/crear/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
    body: JSON.stringify(data)
  });
  const text = await res.text();
  document.getElementById('addResult').innerText = res.ok ? 'Creado correctamente' : ('Error: ' + text);
});


//Lista de Insumos
async function loadList(){
  const res = await fetch('/api/insumos/');
  const data = await res.json();
  const container = document.getElementById('listResult');
  if (!Array.isArray(data)) {
    container.innerText = JSON.stringify(data);
    return;
  }
  let html = '<table class="table"><thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Cantidad</th><th>Marca</th><th>Color</th></tr></thead><tbody>';
  data.forEach(i => {
    html += `<tr><td>${i.id}</td><td>${i.nombre_insumo}</td><td>${i.tipo_insumo || ''}</td><td>${i.cantidad_disponible_insumo || ''}</td><td>${i.marca_insumo || ''}</td><td><span style="display:inline-block;width:20px;height:20px;background-color:${i.color_insumo};border:1px solid #ccc;margin-right:5px;border-radius:3px;"></span>${i.color_insumo || ''}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
document.getElementById('refreshList').addEventListener('click', loadList);


//Detalles especificos de un insumo
document.getElementById('detailForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const id = this.querySelector('input[name="id"]').value;
  const res = await fetch('/api/insumos/' + id + '/');
  if (!res.ok) { document.getElementById('detailResult').innerText = 'No encontrado'; return; }
  const obj = await res.json();
  const container = document.getElementById('detailResult');
  let html = '<table class="table"><thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Cantidad</th><th>Marca</th><th>Color</th></tr></thead><tbody>';
  html += `<tr><td>${obj.id}</td><td>${obj.nombre_insumo}</td><td>${obj.tipo_insumo || ''}</td><td>${obj.cantidad_disponible_insumo || ''}</td><td>${obj.marca_insumo || ''}</td><td><span style="display:inline-block;width:20px;height:20px;background-color:${obj.color_insumo};border:1px solid #ccc;margin-right:5px;border-radius:3px;"></span>${obj.color_insumo || ''}</td></tr>`;
  html += '</tbody></table>';
  container.innerHTML = html;
});



//Actualizar
document.getElementById('updateForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const form = new FormData(this);
  const id = form.get('id');
  const payload = {};
  for (const [k,v] of form.entries()) {
    if (k !== 'id' && v !== '') {
      payload[k] = v;
    }
  }
  if (Object.keys(payload).length === 0) {
    document.getElementById('updateResult').innerText = 'Error: Debes modificar al menos un campo';
    return;
  }
  const res = await fetch('/api/insumos/' + id + '/', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
    body: JSON.stringify(payload)
  });
  const txt = await res.text();
  document.getElementById('updateResult').innerText = res.ok ? 'Actualizado correctamente' : ('Error: ' + txt);
  alert('El insumo se ha modificado correctamente')
});



//Eliminar insumo
document.getElementById('deleteForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const id = this.id.value || this.querySelector('input[name="id"]').value;
  const res = await fetch('/api/insumos/' + id + '/delete/', { method: 'DELETE', headers: {'X-CSRFToken': csrftoken} });
  document.getElementById('deleteResult').innerText = res.ok ? 'Eliminado' : ('Error: ' + await res.text());
});


actionSelect.addEventListener('change', function(){ if (this.value === 'list') loadList(); });
document.addEventListener('DOMContentLoaded', function(){ if (actionSelect.value === 'list') loadList(); });
</script>

{% endblock %}